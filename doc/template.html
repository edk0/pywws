<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
  <head>
    <title>
      Software for WeatherStations: Template.py
    </title>
  </head>
  <body>
    <h1>
      <a href="index.html">Python software for USB Wireless WeatherStations</a>
    </h1>
    <h2>
      <a href="../Template.py">Template.py</a> -- creates text data file based on a template
    </h2>
    <p>
	This is probably the most difficult to use module in the weather station software collection. It generates text files based on a "template" file plus the hourly &amp; daily weather station data. The template processing goes beyond simple substitution of values to include loops, jumps forwards or backwards in the data, processing of the data and substitution of missing values.
    </p>
    <p>
	A template file can be any sort of text file (plain text, xml, html, etc.) to which "processing instructions" have been added. These processing instructions are delimited by hash ('#') characters. They are not copied to the output, but cause something else to happen: either a data value is inserted or one of a limited number of other actions is carried out.
    </p>
    <p>
	Before writing your own template files, it might be useful to look at
some of the examples in the <a href="../example_templates/">example_templates directory</a>.
    </p>
	<h2>Processing instructions</h2>
	<ul>
	<li>
	<b><code>##</code></b>: output a single '#' character.
	</li>
	<li>
	<b><code>#daily#</code></b>: switch to "daily" summary data. The index is reset to the most recent value.
	</li>
	<li>
	<b><code>#hourly#</code></b>: switch to "hourly" summary data. The index is reset to the most recent value.
	</li>
	<li>
	<b><code>#jump count#</code></b>: jump <code>count</code> values. The data index is adjusted by <code>count</code> hours or days. Negative values jump back in time.
	</li>
	<li>
	<b><code>#loop count#</code></b>: start a loop that will repeat <code>count</code> times. <code>Count</code> must be one or more.
	</li>
	<li>
	<b><code>#endloop#</code></b>: end a loop started by <code>#loop count#</code>. The template processing will go back to the line containing the <code>#loop count#</code> instruction. Don't try to nest loops.
	</li>
	<li>
	<b><code>#key fmt_string no_value_string conversion#</code></b>: output a data value. <code>key</code> is the data key, e.g. '<code>temp_out</code>' for outdoor temperature. <code>fmt_string</code> is a printf-like format string (actually Python's % operator) except for datetime values, when it is input to <a href="http://docs.python.org/library/datetime.html#datetime-objects">datetime</a>'s strftime() method. <code>no_value_string</code> is output instead of <code>fmt_string</code> when the data value is absent, e.g. if the station lost contact with the outside sensor. <code>conversion</code> is a Python expression to convert the data, e.g. to convert wind speed from m/s to mph you could use <code>"x * 3.6 / 1.609344"</code>.<br>All these values need double quotes " if they contain spaces or other potentially difficult characters. All except <code>key</code> are optional, but note that if you want to specify a <code>conversion</code>, you also need to specify <code>key</code>, <code>fmt_string</code> and <code>no_value_string</code>.
	</li>
	</ul>
	<h2>Example</h2>
    <p>
	Here is an example snippet showing basic and advanced use of the template features. It is part of the <a href="file:///f|/weather/example_templates/6hrs.txt">6hrs.txt</a> example template file, which generates an HTML table of 7 hourly readings (which should span 6 hours).
    </p>
	<pre>#hourly#
#jump -7#
#loop 7#
#jump 1#
  &lt;tr&gt;
    &lt;td&gt;#idx "%Y/%m/%d" "" "[None, x][x.hour == 0 or loop_count == 7]"#&lt;/td&gt;
    &lt;td&gt;#idx "%H%M"#&lt;/td&gt;
    &lt;td&gt;#temp_out "%.1f &deg;C"#&lt;/td&gt;
    &lt;td&gt;#hum_out "%d%%"#&lt;/td&gt;
    &lt;td&gt;#wind_dir "%s" "-" "wind_dir_text[x]"#&lt;/td&gt;
    &lt;td&gt;#wind_ave "%.0f mph" "" "x * 3.6 / 1.609344"#&lt;/td&gt;
    &lt;td&gt;#wind_gust "%.0f mph" "" "x * 3.6 / 1.609344"#&lt;/td&gt;
    &lt;td&gt;#rain "%0.1f mm"#&lt;/td&gt;
    &lt;td&gt;#pressure "%.0f hPa"#, #pressure_trend "%s" "" "pressure_trend_text(x)"#&lt;/td&gt;
  &lt;/tr&gt;
#endloop#</pre>
    <p>
	The first four lines of this snippet do the following: select hourly data, jump back 7 hours, start a loop with a count of 7, jump forward one hour. The last jump (of one hour) happens each time round the loop, so a sequence of 7 data readings will be output. The last line marks the end of the loop &mdash; everything between the <code>#loop 7#</code> and <code>#endloop#</code> lines is output 7 times.
    </p>
    <p>
	The <code>#temp_out ...#</code>, <code>#hum_out ...#</code>, <code>#rain ...#</code> and <code>#pressure ...#</code> instructions show basic data output. They each use a <code>fmt_string</code> to format the data appropriately. The <code>#wind_ave ...#</code> and <code>#wind_gust ...#</code> instructions show how to use a <code>conversion</code> expression to convert m/s to mph.
    </p>
    <p>
	The <code>#wind_dir ...#</code> and <code>#pressure_trend ...#</code> instructions show use of the built-in array <code>wind_dir_text</code> and function <code>pressure_trend_text</code> to convert numerical values into English text.
    </p>
    <p>
	Finally we get to <a href="http://docs.python.org/library/datetime.html#datetime-objects">datetime</a> values. The <code>#idx "%H%M"#</code> instruction simply outputs the time (in HHMM format) of the data's index. The <code>#idx "%Y/%m/%d" "" "[None, x][x.hour == 0 or loop_count == 7]"#</code> instruction is a bit more complicated. It outputs the date, but only on the first line or if the date has changed. It does this by indexing the array <code>[None, x]</code> with a boolean expression that is true when <code>loop_count</code> is 7 (i.e. on the first pass through the loop) or <code>x.hour</code> is zero (i.e. this is the first hour of the day).
    </p>
	<hr>
	<p>
	&copy; <a href="http://www.jim-easterbrook.me.uk/">Jim Easterbrook</a>. Please email <a href="mailto:jim@jim-easterbrook.me.uk">jim@jim-easterbrook.me.uk</a> with any questions.
	</p>
  </body>
</html>
