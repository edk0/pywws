<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
  <head>
    <title>
      Software for WeatherStations: Template.py
    </title>
  </head>
  <body>
    <h1>
      <a href="index.html">Python software for USB Wireless WeatherStations</a>
    </h1>
    <h2>
      <a href="auto/pywws.Template.html">Template.py</a> -- creates text data file based on a template
    </h2>
    <p>
      This is probably the most difficult to use module in the weather station software collection. It generates text files based on a "template" file plus the raw, hourly, daily &amp; monthly weather station data. The template processing goes beyond simple substitution of values to include loops, jumps forwards or backwards in the data, processing of the data and substitution of missing values.
    </p>
    <p>
      A template file can be any sort of text file (plain text, xml, html, etc.) to which "processing instructions" have been added. These processing instructions are delimited by hash ('#') characters. They are not copied to the output, but cause something else to happen: either a data value is inserted or one of a limited number of other actions is carried out.
    </p>
    <p>
      Before writing your own template files, it might be useful to look at some of the examples in the <a href="../example_templates/">example_templates directory</a>.
    </p>
    <h2>
      Processing instructions
    </h2>
    <ul>
      <li>
        <b><code>##</code></b>: output a single '#' character.
      </li>
      <li>
        <b><code>#monthly#</code></b>: switch to "monthly" summary data. The index is reset to the most recent value.
      </li>
      <li>
        <b><code>#daily#</code></b>: switch to "daily" summary data. The index is reset to the most recent value.
      </li>
      <li>
        <b><code>#hourly#</code></b>: switch to "hourly" summary data. The index is reset to the most recent value.
      </li>
      <li>
        <b><code>#raw#</code></b>: switch to "raw" data. The index is reset to the most recent value.
      </li>
      <li>
        <b><code>#timezone name#</code></b>: convert all datetime values to time zone <code>name</code> before output. Permitted values for <code>name</code> are <code>utc</code> or <code>local</code>.
      </li>
      <li>
        <b><code>#roundtime expr#</code></b>: switch time rounding on or off, according to <code>expr</code>. When time rounding is on, 30 seconds is added to each time value used. This is useful if you are only printing out hours and minutes, e.g. with a "%H:%M" format, and want time values such as 10:23:58 to appear as "10:24". Use "True" or "False" for <code>expr</code>. 
      </li>
      <li>
        <b><code>#jump count#</code></b>: jump <code>count</code> values. The data index is adjusted by <code>count</code> hours or days. Negative values jump back in time.<br>It is a good idea to put jumps within a loop at the end, just before the <code>#endloop#</code> instruction. The loop can then terminate cleanly if it has run out of data.
      </li>
      <li>
        <b><code>#loop count#</code></b>: start a loop that will repeat <code>count</code> times. <code>Count</code> must be one or more.
      </li>
      <li>
        <b><code>#endloop#</code></b>: end a loop started by <code>#loop count#</code>. The template processing will go back to the line containing the <code>#loop count#</code> instruction. Don't try to nest loops.
      </li>
      <li>
        <b><code>#key fmt_string no_value_string conversion#</code></b>: output a data value. <code>key</code> is the data key, e.g. <code>temp_out</code> for outdoor temperature. <code>fmt_string</code> is a printf-like format string (actually Python's % operator) except for datetime values, when it is input to <a href="auto/datetime.html#datetime">datetime</a>'s strftime() method. <code>no_value_string</code> is output instead of <code>fmt_string</code> when the data value is absent, e.g. if the station lost contact with the outside sensor. <code>conversion</code> is a Python expression to convert the data, e.g. to convert wind speed from m/s to mph you could use <code>"x * 3.6 / 1.609344"</code>.<br>
        All these values need double quotes " if they contain spaces or other potentially difficult characters. All except <code>key</code> are optional, but note that if you want to specify a <code>conversion</code>, you also need to specify <code>key</code>, <code>fmt_string</code> and <code>no_value_string</code>.
      </li>
      <li>
        <b><code>#calc expression fmt_string no_value_string conversion#</code></b>: output a value computed from one or more data items. <code>expression</code> is any valid Python expression, e.g. <code>"dew_point(data['temp_out'], data['hum_out'])"</code> to compute the outdoor dew point. <code>fmt_string</code>, <code>no_value_string</code> and <code>conversion</code> are as described above. Note that it is probably more efficient to incorporate any <code>conversion</code> into <code>expression</code>.
      </li>
    </ul>
    <h2>
      Example
    </h2>
    <p>
      Here is an example snippet showing basic and advanced use of the template features. It is part of the <a href="../example_templates/6hrs.txt">6hrs.txt</a> example template file, which generates an HTML table of 7 hourly readings (which should span 6 hours).
    </p>
<pre>
#hourly#
#jump -6#
#loop 7#
  &lt;tr&gt;
    &lt;td&gt;#idx "%Y/%m/%d" "" "[None, x][x.hour == 0 or loop_count == 7]"#&lt;/td&gt;
    &lt;td&gt;#idx "%H%M %Z"#&lt;/td&gt;
    &lt;td&gt;#temp_out "%.1f &deg;C"#&lt;/td&gt;
    &lt;td&gt;#hum_out "%d%%"#&lt;/td&gt;
    &lt;td&gt;#wind_dir "%s" "-" "wind_dir_text[x]"#&lt;/td&gt;
    &lt;td&gt;#wind_ave "%.0f mph" "" "x * 3.6 / 1.609344"#&lt;/td&gt;
    &lt;td&gt;#wind_gust "%.0f mph" "" "x * 3.6 / 1.609344"#&lt;/td&gt;
    &lt;td&gt;#rain "%0.1f mm"#&lt;/td&gt;
    &lt;td&gt;#rel_pressure "%.0f hPa"#, #pressure_trend "%s" "" "pressure_trend_text(x)"#&lt;/td&gt;
  &lt;/tr&gt;
#jump 1#
#endloop#
</pre>
    <p>
      The first three lines of this snippet do the following: select hourly data, jump back 6 hours, start a loop with a count of 7. A jump forward of one hour appears just before the end of the repeated segment. As this last jump (of one hour) happens each time round the loop, a sequence of 7 data readings will be output. The last line marks the end of the loop &mdash; everything between the <code>#loop 7#</code> and <code>#endloop#</code> lines is output 7 times.
    </p>
    <p>
      The <code>#temp_out ...#</code>, <code>#hum_out ...#</code>, <code>#rain ...#</code> and <code>#rel_pressure ...#</code> instructions show basic data output. They each use a <code>fmt_string</code> to format the data appropriately. The <code>#wind_ave ...#</code> and <code>#wind_gust ...#</code> instructions show how to use a <code>conversion</code> expression to convert m/s to mph.
    </p>
    <p>
      The <code>#wind_dir ...#</code> and <code>#pressure_trend ...#</code> instructions show use of the built-in array <code>wind_dir_text</code> and function <code>pressure_trend_text</code> to convert numerical values into English text.
    </p>
    <p>
      Finally we get to <a href="auto/datetime.html#datetime">datetime</a> values. The <code>#idx "%H%M"#</code> instruction simply outputs the time (in HHMM format) of the data's index. The <code>#idx "%Y/%m/%d" "" "[None, x][x.hour == 0 or loop_count == 7]"#</code> instruction is a bit more complicated. It outputs the date, but only on the first line or if the date has changed. It does this by indexing the array <code>[None, x]</code> with a boolean expression that is true when <code>loop_count</code> is 7 (i.e. on the first pass through the loop) or <code>x.hour</code> is zero (i.e. this is the first hour of the day).
    </p>
    <hr>
    <p>
      <a href="http://code.google.com/p/pywws/"><i>Python software for USB Wireless WeatherStations</i></a> &copy; <a href="http://www.jim-easterbrook.me.uk/">Jim Easterbrook</a>.
    </p>
  </body>
</html>